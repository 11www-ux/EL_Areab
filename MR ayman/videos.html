<!doctype html>
<html lang="ar" dir="rtl">

<head>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</title>

    <style>
         :root {
            --accent: #0b74ff;
            --accent-dark: #0a5ee0;
            --bg: #f5f7fb;
            --card: #ffffff;
            --muted: #6b7280;
            --danger: #ef4444;
            --success: #10b981;
        }
        
        * {
            box-sizing: border-box
        }
        
        body {
            margin: 0;
            font-family: "Segoe UI", "Noto Naskh Arabic", Tahoma, Arial, sans-serif;
            background-image: url("bg.webp");
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #0f172a;
            -webkit-font-smoothing: antialiased;
            padding: 28px;
            direction: rtl;
        }
        
        .container {
            max-width: 920px;
            margin: 0 auto
        }
        
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .brand {
            display: flex;
            gap: 12px;
            align-items: center
        }
        
        .logo {
            width: 64px;
            height: 64px;
            border-radius: 14px;
            background: linear-gradient(135deg, var(--accent), #6d28d9);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 22px;
            box-shadow: 0 8px 26px rgba(11, 116, 255, 0.12);
        }
        
        .title h1 {
            margin: 0;
            font-size: 20px
        }
        
        .title p {
            margin: 0;
            font-size: 13px;
            color: var(--muted)
        }
        
        .master {
            text-align: right;
        }
        
        .master .label {
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px
        }
        
        .master .name {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 10px;
            background: var(--card);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
            cursor: text;
            font-weight: 700;
        }
        
        main {
            display: grid;
            grid-template-columns: 1fr;
            gap: 18px
        }
        
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 30px rgba(15, 23, 42, 0.04);
        }
        
        label {
            font-size: 13px;
            color: var(--muted);
            display: block;
            margin-bottom: 8px
        }
        
        select,
        input[type="text"],
        input[type="url"] {
            width: 100%;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #e6eef9;
            background: #fbfdff;
            font-size: 15px;
            outline: none;
        }
        
        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap
        }
        
        .col {
            flex: 1;
            min-width: 180px
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 12px;
            border: 0;
            background: var(--accent);
            color: white;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(11, 116, 255, 0.12);
        }
        
        .btn.ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid rgba(11, 116, 255, 0.12);
            box-shadow: none
        }
        
        .muted {
            color: var(--muted);
            font-size: 13px
        }
        
        .video-wrap {
            margin-top: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center
        }
        
        iframe.video {
            width: 100%;
            height: 480px;
            border-radius: 12px;
            border: none;
            background: #000;
            display: none;
            max-width: 900px
        }
        
        .video-card {
            width: 100%;
            max-width: 920px
        }
        
        .meta-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%
        }
        
        .meta-row .lesson {
            font-weight: 800
        }
        
        .meta-row .status {
            color: var(--muted);
            font-size: 13px
        }
        
        footer {
            margin-top: 18px;
            text-align: center;
            color: var(--muted);
            font-size: 13px
        }
        /* snackbar */
        
        .snackbar {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: -100px;
            background: #111827;
            color: white;
            padding: 12px 18px;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(2, 6, 23, 0.3);
            transition: bottom 0.35s ease, opacity 0.35s ease;
            opacity: 0;
            z-index: 9999;
            max-width: 92%;
        }
        
        .snackbar.show {
            bottom: 28px;
            opacity: 1;
        }
        
        .snackbar.success {
            background: var(--success);
            color: white;
        }
        
        .snackbar.error {
            background: var(--danger);
            color: white;
        }
        /* spinner */
        
        .spinner {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid rgba(0, 0, 0, 0.08);
            border-top-color: var(--accent);
            animation: spin 0.9s linear infinite;
            display: inline-block;
            margin-left: 10px;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg)
            }
        }
        
        .manual-area {
            display: none;
            width: 100%;
            gap: 8px;
            align-items: center;
            margin-top: 8px
        }
        
        .manual-area input {
            flex: 1
        }
        
        @media (max-width:820px) {
            iframe.video {
                height: 320px
            }
        }
    </style>
</head>

<body>

    <div class="container">
    
        <header>
        
            <div class="brand">
            
                <div class="title" style="
Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  Â  Â  Â  padding: 15px 25px;
Â  Â  Â  Â  Â  border-radius: 15px;
Â  Â  Â  Â  Â  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  border: 1px solid rgba(255,255,255,0.2);
Â  Â  Â  Â  ">
                
                    <h1 style="color: #2563eb;">Ù…Ø±Ø­Ø¨Ø§! Ø¨Ù‚Ø±ØªÙŠ Ø§Ù„Ø¶Ø§Ø­ÙƒØ©ğŸ¥°</h1>
                    </div>
                </div>


        
            <div class="master">
            
                <div class="label"></div>
            
                <div id="masterName" class="name"> Ø§Ù„Ø£Ø±ÙŠØ¨ </div>
                </div>
            </header>

    
        <main>
        
            <section class="card">
            
                <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
                
                    <div>
                        <strong>Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</strong>
                        <div class="muted">Ø§Ø®ØªØ± ØµÙÙƒØŒ Ø«Ù… Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ø¶ØºØ· Ø¹Ø±Ø¶</div>
                        </div>
                    </div>

            
                <div style="height:12px"></div>

            
                <div class="row">
                
                    <div class="col">
                        <label>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</label> Â  Â  Â  Â  Â  Â  <select id="gradeSelect">
Â  Â  Â  Â  Â  Â  Â  <option value="s1">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
Â  Â  Â  Â  Â  Â  Â  <option value="s2">ØªØ§Ù†ÙŠÙ‡ Ø«Ø§Ù†ÙˆÙŠ</option>
Â  Â  Â  Â  Â  Â  Â  <option value="s3">ØªØ§Ù„ØªÙ‡ Ø«Ø§Ù†ÙˆÙŠ</option>
Â  Â  Â  Â  Â  Â  </select> Â  Â  Â  Â  Â  </div>

                
                    <div class="col">
                        <label>Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯</label> Â  Â  Â  Â  Â  Â  <input id="studentCode" type="text" placeholder="Ù…Ø«Ø§Ù„: AB12CD34" /> Â  Â  Â  Â  Â  </div>

                
                    <div style="display:flex;align-items:flex-end;gap:8px">
                        <button id="showBtn" class="btn">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©</button> Â  Â  Â  Â  Â  </div>
                    </div>

            
                <div id="loadingRow" style="margin-top:12px;display:none;align-items:center">
                
                    <div class="spinner"></div>
                
                    <div style="margin-right:10px;color:var(--muted)">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆÙØªØ­ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©...</div>
                    </div>

            
                <div class="video-card" style="margin-top:14px">
                
                    <div class="card video-wrap" style="padding:12px">
                    
                        <div class="meta-row">
                        
                            <div class="lesson" id="videoTitle">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
                        
                            <div class="status" id="videoStatus">Ø§Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ø¶ØºØ· Ø¹Ø±Ø¶</div>
                            </div>

                        <iframe id="videoFrame" class="video" src="" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                        <div id="manualArea" class="manual-area">
                            <input id="manualLink" type="url" placeholder="Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³ Ø¥Ø°Ø§ Ù„Ù… ØªØ¬Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©" /> Â  Â  Â  Â  Â  Â  Â  <button id="useManual" class="btn" style="display:none;">Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù„ÙŠÙ†Ùƒ</button> Â  Â  Â  Â  Â  Â  </div>

                        </div>
                    </div>

                </section>

            </div>
    </footer>
    </main>
    </div>


    <div id="snackbar" class="snackbar">Ù†Øµ ØªØ¬Ø±ÙŠØ¨ÙŠ</div>

    <footer style="
Â  position: relative;
Â  z-index: 9999;
Â  text-align: center;
Â  padding: 40px 0;
Â  margin-top: 50px;
Â  background: transparent;
">
    
        <div style="
Â  Â  background: rgba(255, 255, 255, 0.95);
Â  Â  color: #111;
Â  Â  max-width: 400px;
Â  Â  margin: 0 auto;
Â  Â  border-radius: 20px;
Â  Â  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
Â  Â  border: 1px solid #ddd;
Â  Â  padding: 25px;
Â  ">
        
            <p style="font-weight: 600; margin-bottom: 15px; font-size: 16px;">
                ØµÙÙ…Ù‘Ù… Ø¨ÙˆØ§Ø³Ø·Ø©Â  Â  Â  Â  <span style="color: #2563eb; font-weight: 700;">Abdelrahman Tarek</span> Â  Â  </p>
        
            <a href="https://t.me/yourusername" target="_blank" Â  Â  Â  Â  Â style="
Â  Â  Â  Â  Â display: inline-flex;
Â  Â  Â  Â  Â align-items: center;
Â  Â  Â  Â  Â gap: 8px;
Â  Â  Â  Â  Â background: linear-gradient(to right, #2563eb, #3b82f6);
Â  Â  Â  Â  Â color: #fff;
Â  Â  Â  Â  Â font-weight: 600;
Â  Â  Â  Â  Â font-size: 14px;
Â  Â  Â  Â  Â padding: 10px 18px;
Â  Â  Â  Â  Â border-radius: 9999px;
Â  Â  Â  Â  Â text-decoration: none;
Â  Â  Â  Â  Â box-shadow: 0 2px 10px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â transition: all 0.3s;
Â  Â  Â  Â " Â  Â  Â  Â onmouseover="this.style.background='linear-gradient(to right,#3b82f6,#60a5fa)'" Â  Â  Â  Â onmouseout="this.style.background='linear-gradient(to right,#2563eb,#3b82f6)'">
                <i class="fa-solid fa-envelope"></i> Â  Â  Â  ØªÙˆØ§ØµÙ„ Ù…Ø¹Ù†Ø§ Â  Â  </a>
            </div>
    </footer>









    <script>
        const $ = id => document.getElementById(id);
        const snackbar = $('snackbar');

        // *************************************************************
        // ** âš ï¸ ÙŠØ¬Ø¨ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù‚ÙŠÙ… Placeholder Ø¨Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© âš ï¸ **
        // *************************************************************
        // Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙØªØ§Ø­ ANON KEY Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
        const SUPABASE_URL = "https://arbbxmnjviryxkmhwdgk.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyYmJ4bW5qdmlyeXhrbWh3ZGdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI2OTU1NDEsImV4cCI6MjA3ODI3MTU0MX0.G-MsJtbQ1LlPZO-Vob6nKzdClHmOYu6RFOKi62FKKNk";
        const TABLE_CODES = "video_codes";
        const TABLE_VIDEOS = "videos";
        // *************************************************************


        function showSnackbar(text, type = 'info', duration = 3000) {Â 
            snackbar.textContent = text;Â 
            snackbar.className = 'snackbar show';Â 
            if (type === 'success') snackbar.classList.add('success');Â 
            else if (type === 'error') snackbar.classList.add('error');

            Â 
            setTimeout(() => {Â Â 
                snackbar.className = 'snackbar';Â 
            }, duration);
        }

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø±Ø§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø¥Ù„Ù‰ Ø±Ø§Ø¨Ø· Embed
        function convertYouTubeLink(link) {Â 
            if (!link) return "";Â 
            link = link.trim();Â Â  // Ù†Ù…Ø· Ø¨Ø­Ø« Ø¹Ù† ID ÙÙŠ Ø¬Ù…ÙŠØ¹ ØµÙŠØº Ø±ÙˆØ§Ø¨Ø· ÙŠÙˆØªÙŠÙˆØ¨ Ø§Ù„Ù…Ø¹Ø±ÙˆÙØ©
            Â 
            const regex = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;Â 
            const match = link.match(regex);Â Â 
            if (match && match[1].length === 11) {Â Â 
                const id = match[1];Â Â 
                return `https://www.youtube.com/embed/${id}`;Â 
            }Â Â  // Ù„Ùˆ Ø§Ù„Ø±Ø§Ø¨Ø· ÙŠØ¨Ø¯Ùˆ Ø£Ù†Ù‡ ÙÙ‚Ø· id
            Â 
            if (/^[A-Za-z0-9_-]{6,}$/.test(link)) {Â Â 
                return `https://www.youtube.com/embed/${link}`;Â 
            }Â  // fallback: Ù†ÙØ¹ÙŠØ¯ ÙƒÙ…Ø§ Ù‡Ùˆ
            Â 
            return link;
        }


        /* =========================
        Â  Â Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø­Ø°Ù ÙÙŠ Supabase (Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        Â  Â ========================= */

        async function validateCodeAndGetVideo(code) {Â  // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
            Â  // Ù†Ø³ØªØ®Ø¯Ù… "videos(video_link,video_name)" Ù„Ø¹Ù…Ù„ join ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø±ØªØ¨Ø·
            Â 
            const url = `${SUPABASE_URL}/rest/v1/${TABLE_CODES}?select=id,videos(video_link,video_name)&code=eq.${code}`;

            Â 
            let lookupResponse;Â 
            try {Â Â 
                lookupResponse = await fetch(url, {Â Â Â 
                    method: 'GET',
                    Â Â Â headers: {Â Â Â Â 
                        'apikey': SUPABASE_ANON_KEY,
                        Â Â Â Â 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        Â Â Â 
                    }Â Â 
                });Â 
            } catch (e) {Â Â 
                throw new Error('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');Â 
            }

            Â 
            if (!lookupResponse.ok) {Â Â 
                console.error('Supabase Lookup Error:', await lookupResponse.text());Â Â 
                throw new Error('ÙØ´Ù„ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„/Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª).');Â 
            }Â Â 
            const data = await lookupResponse.json();

            Â 
            if (data.length === 0) {Â Â 
                return null; // Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡
                Â 
            }

            Â 
            const record = data[0];Â 
            const videoLink = record.videos.video_link;Â 
            const videoTitle = record.videos.video_name;Â 
            const codeId = record.id; // ID Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ø³Ù†Ù…Ø³Ø­Ù‡

            Â  // 2. Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (DELETE)
            Â 
            const deleteUrl = `${SUPABASE_URL}/rest/v1/${TABLE_CODES}?id=eq.${codeId}`;Â 
            const deleteResponse = await fetch(deleteUrl, {Â Â 
                method: 'DELETE',
                Â Â headers: {Â Â Â 
                    'apikey': SUPABASE_ANON_KEY,
                    Â Â Â 'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    Â Â Â 'Prefer': 'return=minimal'Â Â 
                }Â 
            });Â Â 
            if (!deleteResponse.ok) {Â Â  // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù (Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø¨Ø³Ø¨Ø¨ RLS)ØŒ Ù†Ø³Ø¬Ù„ Ø§Ù„Ø®Ø·Ø£ ÙˆÙ†Ø³ØªÙ…Ø± ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                Â Â 
                console.error('ØªØ­Ø°ÙŠØ±: ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù….', await deleteResponse.text());Â Â 
                showSnackbar('ØªØ­Ø°ÙŠØ±: Ø§Ù„ÙƒÙˆØ¯ ØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ØŒ Ù„ÙƒÙ†Ù‡ Ù„Ù… ÙŠÙØ­Ø°Ù Ù…Ù† Ø§Ù„Ø³Ø¬Ù„. ÙŠÙØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯Ø±Ø³.', 'info', 6000);Â 
            } else {Â Â 
                console.log('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­.');Â 
            }

            Â 
            return {
                link: videoLink,
                title: videoTitle
            };
        }


        function loadAndShowVideo(rawLink, lesson) {Â 
            const finalEmbedLink = convertYouTubeLink(rawLink);

            Â 
            console.log("DEBUG: Link from Supabase ->", rawLink);Â 
            console.log("DEBUG: Converted embed link ->", finalEmbedLink);

            Â 
            const frame = $('videoFrame');Â 
            frame.style.display = 'none';Â 
            frame.src = ''; // reset
            Â 
            $('videoTitle').textContent = lesson;Â 
            $('videoStatus').textContent = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø©...';Â 
            $('loadingRow').style.display = 'flex';Â 
            $('manualArea').style.display = 'none';

            Â  // Timeout detection
            Â 
            let timedOut = false;Â 
            const timeoutId = setTimeout(() => {Â Â 
                timedOut = true;Â Â 
                $('loadingRow').style.display = 'none';Â Â 
                $('videoStatus').textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ (timeout)';Â Â 
                showSnackbar('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø®Ù„Ø§Ù„ 7 Ø«ÙˆØ§Ù†Ù.', 'error', 6000);Â 
            }, 7000);

            Â  // onload/onerror
            Â 
            frame.onload = function() {Â Â 
                if (timedOut) return;Â Â 
                clearTimeout(timeoutId);Â Â 
                $('loadingRow').style.display = 'none';Â Â 
                frame.style.display = 'block';Â Â 
                $('videoStatus').textContent = 'ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø§Ù„Ø¢Ù†';Â Â 
                showSnackbar('ØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success', 2000);Â 
            };Â 
            frame.onerror = function() {Â Â 
                clearTimeout(timeoutId);Â Â 
                $('loadingRow').style.display = 'none';Â Â 
                $('videoStatus').textContent = 'ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (iframe error)';Â Â 
                showSnackbar('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±. Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ø§Ù„Ø±Ø§Ø¨Ø· Ø®Ø§Ø·Ø¦Ø§Ù‹.', 'error', 6000);Â 
            };

            Â  // Set src
            Â 
            try {Â Â 
                frame.src = finalEmbedLink;Â Â 
                console.log("DEBUG: iframe.src set ->", frame.src);Â 
            } catch (e) {Â Â 
                clearTimeout(timeoutId);Â Â 
                $('loadingRow').style.display = 'none';Â Â 
                $('videoStatus').textContent = 'Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ¹ÙŠÙŠÙ† src';Â Â 
                console.error("DEBUG: setting iframe.src threw:", e);Â Â 
                showSnackbar('ØªØ¹Ø°Ø± ØªØ¹ÙŠÙŠÙ† Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù„Ù„Ø¥Ø·Ø§Ø± (Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ).', 'error', 6000);Â 
            }
        }


        /* =========================
        Â  Â Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© (CORE LOGIC)
        Â  Â ========================= */
        $('showBtn').addEventListener('click', async() => {Â 
            const codeRaw = $('studentCode').value.trim();Â 
            if (!codeRaw) {
                showSnackbar('Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }Â 
            const code = codeRaw.toUpperCase();

            Â  // show loading
            Â 
            $('loadingRow').style.display = 'flex';Â 
            $('videoStatus').textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...';Â 
            $('videoFrame').style.display = 'none';Â 
            $('videoFrame').src = '';Â 
            $('manualArea').style.display = 'none';


            Â 
            try {Â Â  // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ ÙˆØ­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ÙˆØ§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                Â Â 
                const result = await validateCodeAndGetVideo(code);

                Â Â 
                if (!result) {Â Â Â 
                    $('loadingRow').style.display = 'none';Â Â Â 
                    $('videoStatus').textContent = 'Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­';Â Â Â 
                    showSnackbar('Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù…Ø³Ø¨Ù‚Ù‹Ø§.', 'error', 4000);Â Â Â 
                    return;Â Â 
                }

                Â Â  // 2. Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
                Â Â 
                loadAndShowVideo(result.link, result.title);

                Â 
            } catch (err) {Â Â 
                console.error(err);Â Â 
                showSnackbar('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ' + (err.message || err), 'error', 6000);Â Â 
                $('videoStatus').textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£';Â Â 
                $('loadingRow').style.display = 'none';Â 
            }
        });


        /* Ù…Ø³Ø§Ø¹Ø¯Ø©: Ø§Ù„Ø¶ØºØ· Enter Ø¯Ø§Ø®Ù„ Ø­Ù‚Ù„ Ø§Ù„ÙƒÙˆØ¯ */
        $('studentCode').addEventListener('keydown', (e) => {Â 
            if (e.key === 'Enter') $('showBtn').click();
        });
    </script>
</body>


</html>
