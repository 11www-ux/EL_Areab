<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mr Ayman - Quiz</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }
        .card label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: block;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #FFFFFF; /* White */
            color: #1F2937; /* Gray-800 */
            margin-bottom: 0.5rem;
            border: 2px solid #E5E7EB; /* Gray-200 */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .card label:hover {
            background-color: #F9FAFB; /* Gray-50 */
            border-color: #6366F1; /* Indigo-500 */
        }
        .card input[type="radio"] {
            display: none;
        }
        .selected-answer {
            background-color: #4338CA !important; /* Indigo-700 */
            border-color: #A5B4FC !important; /* Indigo-300 */
            color: white !important;
        }
        .correct-answer {
            background-color: #10B981 !important; /* Green-500 */
            color: white !important;
            border-color: #34D399 !important; /* Green-400 */
        }
        .incorrect-answer {
            background-color: #EF4444 !important; /* Red-500 */
            color: white !important;
            border-color: #F87171 !important; /* Red-400 */
        }
        .explanation {
            background-color: #FFFBEB; /* Yellow-50 (very light) */
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            border-left: 4px solid #F59E0B; /* Amber-500 */
            color: #92400E; /* Amber-900 (dark text) */
            animation: fadeIn 0.5s;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col items-center p-4 sm:p-6">

    <header class="w-full max-w-4xl text-center bg-gradient-to-r from-blue-400 to-indigo-600 p-6 rounded-3xl shadow-xl mb-8 fade-in text-white">
        <h1 class="text-4xl font-extrabold">Mr Ayman</h1>
        <p class="text-xl mt-2 opacity-95">Quiz</p>
    </header>

    <main id="classSelection" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-xl text-center fade-in border border-gray-200">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ</h2>
        <select id="classSelect" class="w-full bg-gray-100 text-gray-800 p-3 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-indigo-500 transition">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ --</option>
            <option value="s1">Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="s2">ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ</option>
            <option value="s3">ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ</option>
        </select>
        <button id="startBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition transform hover:scale-[1.02] shadow-md">
            Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
        </button>
    </main>

    <section id="quizSection" class="hidden w-full max-w-4xl mt-8 fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-xl mb-6 border border-gray-200">
            <input id="studentName" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" class="w-full p-3 bg-gray-100 text-gray-900 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-purple-500 transition mb-4" required>
            <input id="studentPhone" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… ØªÙ„ÙŠÙÙˆÙ†Ùƒ Ù‡Ù†Ø§" class="w-full p-3 bg-gray-100 text-gray-900 rounded-lg border-2 border-gray-300 focus:outline-none focus:border-purple-500 transition" required>
        </div>
        <form id="quizForm" class="space-y-6"></form>
        <div id="result" class="mt-6 text-2xl font-bold text-center p-4 bg-green-50 text-green-800 rounded-2xl shadow-lg hidden border-l-8 border-green-400"></div>
        <button id="submitBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mt-6 transition transform hover:scale-[1.02] shadow-md">
            Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
        </button>
    </section>

    <a href="https://wa.me/201284023841" target="_blank" class="fixed bottom-6 right-6 bg-green-500 hover:bg-green-600 text-white px-5 py-3 rounded-full shadow-xl transition transform hover:scale-110 z-50 flex items-center space-x-2 space-x-reverse">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a8 8 0 100 16 8 8 0 000-16zM2 10a8 8 0 1116 0 8 8 0 01-16 0zm10.293-3.293a1 1 0 00-1.414 0L9 8.586 7.707 7.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l3-3a1 1 0 000-1.414z" clip-rule="evenodd" fill-rule="evenodd"></path></svg>
        <span>ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø³ØªØ±</span>
    </a>
    
    <footer class="w-full max-w-xs text-center mt-12 mb-4 fade-in">
        <a href="https://wa.me/201094724932" target="_blank" class="block bg-gray-900 text-white py-4 px-6 rounded-2xl shadow-lg hover:bg-gray-700 transition cursor-pointer">
            <p class="font-bold text-lg">ØµÙÙ…Ù… Ø¨ÙˆØ§Ø³Ø·Ø© Abdelrahman Tarek</p>
            <p class="text-sm text-gray-300 mt-1">Ø§Ù†Ù‚Ø± Ù„Ù„ØªÙˆØ§ØµÙ„</p>
        </a>
    </footer>

    <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzKAWpTawaPRZ2_8BCRcjUfeOjWe5UgmRt6vX1V3SeTreKWja89FsgX3L9T_wVrESi82g/exec";

    // ----- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Airtable (Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ… Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„Ø¯ÙŠÙƒ) -----
    // Ø§ÙƒØªØ¨ Ù‡Ù†Ø§ Ø§Ù„Ù€ BASE ID ÙˆØ§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Table name) ÙˆØ§Ù„ØªÙˆÙƒÙ†
    const AIRTABLE_BASE_ID = ""; // Ù…Ø«Ø§Ù„: appXXXXXXXXXXXXXX
    const AIRTABLE_TABLE_NAME = "";   // Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙƒÙ…Ø§ Ù‡Ùˆ ÙÙŠ Airtable (Ø­Ø³Ù‘Ø§Ø³ Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø­Ø±Ù)
    const AIRTABLE_TOKEN = ""; // Ø¶Ø¹ ØªÙˆÙƒÙ† Ø§Ù„Ù€ API Ù‡Ù†Ø§
    // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„ÙˆØ§Ø¬Ù‡Ø© Airtable API
    const AIRTABLE_ENDPOINT = `https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${encodeURIComponent(AIRTABLE_TABLE_NAME)}`;
    // -----------------------------------------------------------------

        let questions = [];
        let correctAnswers = {};
        let explanations = {};
        let selectedClass = "";

        const classNames = {
            g1: "Ø£ÙˆÙ„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", g2: "ØªØ§Ù†ÙŠØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ", g3: "ØªØ§Ù„ØªØ© Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ",
            s1: "Ø£ÙˆÙ„Ù‰ Ø«Ø§Ù†ÙˆÙŠ", s2: "ØªØ§Ù†ÙŠØ© Ø«Ø§Ù†ÙˆÙŠ", s3: "ØªØ§Ù„ØªØ© Ø«Ø§Ù†ÙˆÙŠ"
        };

        document.getElementById("startBtn").addEventListener("click", async () => {
            selectedClass = document.getElementById("classSelect").value;
            if (!selectedClass) {
                alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± Ø§Ù„ØµÙ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
                return;
            }

            document.getElementById("startBtn").textContent = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©...";
            document.getElementById("startBtn").disabled = true;

            try {
                let res = await fetch(scriptURL, {
                    method: "POST",
                    body: JSON.stringify({ type: "getQuestions", classSheet: `questions_${selectedClass}` })
                });
                questions = await res.json();
                showQuestions();
                document.getElementById("classSelection").classList.add("hidden");
                document.getElementById("quizSection").classList.remove("hidden");
            } catch (error) {
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.");
                document.getElementById("startBtn").textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±";
                document.getElementById("startBtn").disabled = false;
            }
        });

        function showQuestions() {
            const form = document.getElementById("quizForm");
            form.innerHTML = "";
            questions.forEach((q, index) => {
                correctAnswers[q.id] = q.correct;
                explanations[q.id] = q.explanation;

                let choicesHtml = q.choices.map(c => `
                    <label>
                        <input type="radio" name="${q.id}" value="${c}">
                        <span>${c}</span>
                    </label>
                `).join("");

                let html = `
                    <div class="card bg-white p-5 rounded-2xl shadow-lg border border-gray-200 fade-in" style="animation-delay: ${index * 100}ms;">
                        <p class="font-bold text-lg mb-4 text-gray-800">${index + 1}. ${q.question}</p>
                        <div class="choices space-y-2">${choicesHtml}</div>
                    </div>
                `;
                form.innerHTML += html;
            });
            
            // Add event listener for selecting answers
            form.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    // Remove selection from siblings
                    const parent = event.target.closest('.choices');
                    parent.querySelectorAll('label').forEach(label => label.classList.remove('selected-answer'));
                    // Add selection to current
                    event.target.parentElement.classList.add('selected-answer');
                });
            });
        }

        document.getElementById("submitBtn").addEventListener("click", async (e) => {
            e.preventDefault();
            const name = document.getElementById("studentName").value.trim();
            const phone = document.getElementById("studentPhone").value.trim();
            if (!name || !phone) {
                alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©");
                return;
            }

            document.getElementById("submitBtn").disabled = true;
            document.getElementById("submitBtn").textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØµØ­ÙŠØ­...";

            let score = 0, wrong = [], total = questions.length;
            questions.forEach(q => {
                const selectedRadio = document.querySelector(`input[name="${q.id}"]:checked`);
                const card = selectedRadio ? selectedRadio.closest(".card") : document.querySelector(`input[name="${q.id}"]`).closest('.card');
                
                document.querySelectorAll(`input[name="${q.id}"]`).forEach(opt => {
                    const label = opt.parentElement;
                    label.classList.remove('selected-answer'); // Clear selection style
                    // Set the correct answer style
                    if (opt.value === q.correct) {
                        label.classList.add('correct-answer');
                    }
                });

                if (selectedRadio) {
                    const selectedLabel = selectedRadio.parentElement;
                    if (selectedRadio.value === q.correct) {
                        score++;
                    } else {
                        // Set the incorrect answer style
                        selectedLabel.classList.add('incorrect-answer');
                        wrong.push(q.id);
                        if (q.explanation) {
                            const exp = document.createElement("div");
                            exp.className = "explanation";
                            exp.innerHTML = `<b>ğŸ’¡ Ø§Ù„Ø´Ø±Ø­:</b> ${q.explanation}`;
                            card.appendChild(exp);
                        }
                    }
                } else {
                    // If not selected, it's considered wrong and show explanation
                    wrong.push(q.id);
                    if (q.explanation) {
                        const exp = document.createElement("div");
                        exp.className = "explanation";
                        exp.innerHTML = `<b>ğŸ’¡ Ø§Ù„Ø´Ø±Ø­:</b> ${q.explanation}`;
                        card.appendChild(exp);
                    }
                }
            });

            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = `âœ… Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${score} / ${total}`;
            resultDiv.classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });

            document.getElementById("submitBtn").style.display = 'none';

            try {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙ‚Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Airtable ÙØ§Ù„Ø£ÙØ¶Ù„ Ø¥Ø±Ø³Ø§Ù„ Ù†Ø³Ø®Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù€ Google Script ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                const useAirtable = AIRTABLE_BASE_ID !== "YOUR_BASE_ID" && AIRTABLE_TOKEN !== "YOUR_AIRTABLE_TOKEN" && AIRTABLE_BASE_ID;

                // Ù†Ø¨Ù†ÙŠ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø­ÙŠØ« Ù†Ø±Ø³Ù„ Ø§Ù„ØµÙ ÙƒØ­Ù‚Ù„ Ù†ØµÙŠ Ù„ØªØ¬Ù†Ø¨ Ù…Ø´ÙƒÙ„Ø§Øª Single Select ÙÙŠ Airtable
                const classValue = classNames[selectedClass] || selectedClass;
                const fields = {
                    "Timestamp": new Date().toISOString(),
                    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙ ÙÙŠ Ø­Ù‚Ù„ Ù†ØµÙŠ Ø¨Ø§Ø³Ù… Class_text (Ø£Ù†Ø´Ø¦ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙÙŠ Airtable ÙƒÙ€ Single line text)
                    "Class_text": classValue,
                    "Name": name,
                    "Phone": phone,
                    "Score": score,
                    "Total": total,
                    "WrongQuestions": wrong.join(',')
                };

                if (useAirtable) {
                    // Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Airtable
                    const res = await fetch(AIRTABLE_ENDPOINT, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${AIRTABLE_TOKEN}`
                        },
                        body: JSON.stringify({ fields })
                    });

                    if (!res.ok) {
                        // Ø­Ø§ÙˆÙ„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¬ÙˆØ§Ø¨ ÙƒÙ€ JSON Ù„Ù…Ø¹Ø±ÙØ© Ø³Ø¨Ø¨ Ø§Ù„Ø®Ø·Ø£
                        let errBody = null;
                        try { errBody = await res.json(); } catch (e) { errBody = await res.text(); }
                        console.error('Airtable error:', res.status, errBody);

                        // ØªØ¹Ø§Ù…Ù„ Ø®Ø§Øµ Ù…Ø¹ Ø®Ø·Ø£ Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù€ select ØºÙŠØ± Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§
                        if (errBody && errBody.error && errBody.error.type === 'INVALID_MULTIPLE_CHOICE_OPTIONS') {
                            // Ø§Ø­ØªÙ…Ø§Ù„ Ø£Ù† Ø§Ù„Ø­Ù‚Ù„ "Class" ÙÙŠ Ø§Ù„Ù€ Airtable Ù‡Ùˆ Single Select ÙˆÙ„Ø§ ÙŠÙ‚Ø¨Ù„ Ù‚ÙŠÙ…Ø© Ø¬Ø¯ÙŠØ¯Ø©.
                            // => Ù†Ø¬Ø±Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø­Ù‚Ù„ Ù†ØµÙŠ Ø¨Ø¯ÙŠÙ„ (Ù…Ø«Ù„Ø§Ù‹ 'Class_text') Ø¥Ù† ÙˆØ¬Ø¯
                            const altFieldName = 'Class_text'; // Ø£Ù†Ø´Ø¦ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ÙÙŠ Ø¬Ø¯ÙˆÙ„Ùƒ ÙƒÙ€ 'Single line text' Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø§Ø³Ù… Ø¥Ù† Ù„Ø²Ù…
                            const altFields = Object.assign({}, fields);
                            // Ø¶Ø¹ Ø§Ù„Ù‚ÙŠÙ…Ø© ÙÙŠ Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø¨Ø¯ÙŠÙ„ ÙˆØ§Ø­Ø°Ù Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„ØªØ¬Ù†Ø¨ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø®ÙŠØ§Ø± Ø¬Ø¯ÙŠØ¯
                            altFields[altFieldName] = altFields['Class'];
                            delete altFields['Class'];

                            try {
                                const retryRes = await fetch(AIRTABLE_ENDPOINT, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${AIRTABLE_TOKEN}`
                                    },
                                    body: JSON.stringify({ fields: altFields })
                                });

                                if (!retryRes.ok) {
                                    // Ø¥Ø°Ø§ Ø§Ù„ÙØ´Ù„ Ù…Ø³ØªÙ…Ø± Ù†Ø®Ø·Ù‘Ø± ÙˆÙ†Ø±Ø³Ù„ Ù„Ù„Ù€ Google Script ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
                                    let retryErr = null;
                                    try { retryErr = await retryRes.json(); } catch(e) { retryErr = await retryRes.text(); }
                                    console.error('Airtable retry error:', retryRes.status, retryErr);
                                    await fetch(scriptURL, {
                                        method: "POST",
                                        headers: { "Content-Type": "application/json" },
                                        body: JSON.stringify({
                                            type: "saveResult",
                                            className: classNames[selectedClass],
                                            name: name,
                                            phone: phone,
                                            score: score,
                                            total: total,
                                            wrong: wrong
                                        })
                                    });
                                }
                            } catch (e) {
                                console.error('Retry to Airtable failed:', e);
                                await fetch(scriptURL, {
                                    method: "POST",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({
                                        type: "saveResult",
                                        className: classNames[selectedClass],
                                        name: name,
                                        phone: phone,
                                        score: score,
                                        total: total,
                                        wrong: wrong
                                    })
                                });
                            }
                        } else {
                            // ÙƒÙ†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŒ Ù†Ø­Ø§ÙˆÙ„ Ø­ÙØ¸ Ù†ÙØ³ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Google Script
                            await fetch(scriptURL, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    type: "saveResult",
                                    className: classNames[selectedClass],
                                    name: name,
                                    phone: phone,
                                    score: score,
                                    total: total,
                                    wrong: wrong
                                })
                            });
                        }
                    }
                } else {
                    // Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Airtable Ø¨Ø¹Ø¯ -> Ù†Ø±Ø³Ù„ Ø¥Ù„Ù‰ Google Script ÙƒÙ…Ø§ ÙƒØ§Ù† Ù…Ø³Ø¨Ù‚Ù‹Ø§
                    await fetch(scriptURL, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            type: "saveResult",
                            className: classNames[selectedClass],
                            name: name,
                            phone: phone,
                            score: score,
                            total: total,
                            wrong: wrong
                        }),
                    });
                }

            } catch (error) {
                console.error('Failed to save result:', error);
            }
        });
    </script>
</body>

</html>